name: CI/CD Pipeline for PCE-MCP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  GO_VERSION: '1.21'

jobs:
  # ========================================
  # Stage 1: Lint (å…è®¸å¤±è´¥)
  # ========================================
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m
      continue-on-error: true  # ä»£ç è´¨é‡é—®é¢˜ä¸é˜»æ­¢æµç¨‹
    
    - name: Check Go formatting
      run: |
        if [ -n "$(gofmt -s -l .)" ]; then
          echo "âš ï¸ Go code formatting issues found (not blocking)"
          gofmt -s -d .
        else
          echo "âœ… Go code is properly formatted"
        fi
      continue-on-error: true

  # ========================================
  # Stage 2: Test
  # ========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Download dependencies
      run: go mod download
    
    - name: Verify dependencies
      run: go mod verify
    
    - name: Run unit tests
      run: |
        go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
      continue-on-error: true  # æµ‹è¯•å¤±è´¥ä¸é˜»æ­¢æž„å»º
    
    - name: Generate coverage report
      run: |
        go tool cover -func=coverage.txt || echo "No coverage data"
      continue-on-error: true
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4  # æ›´æ–°åˆ° v4
      with:
        name: coverage-report
        path: coverage.txt
        retention-days: 30
      continue-on-error: true

  # ========================================
  # Stage 3: Build Multi-Platform Binaries
  # ========================================
  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Build binary for ${{ matrix.os }}-${{ matrix.arch }}
      run: |
        BINARY_NAME=pce-mcp-${{ matrix.os }}-${{ matrix.arch }}
        if [ "${{ matrix.os }}" = "windows" ]; then
          BINARY_NAME="${BINARY_NAME}.exe"
        fi
        
        echo "Building ${BINARY_NAME}..."
        GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -v -o ${BINARY_NAME} ./...
        
        echo "âœ… Build successful: ${BINARY_NAME}"
        ls -lh ${BINARY_NAME}
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v4  # æ›´æ–°åˆ° v4
      with:
        name: pce-mcp-${{ matrix.os }}-${{ matrix.arch }}
        path: pce-mcp-*
        retention-days: 30

  # ========================================
  # Stage 4: Create Release Summary
  # ========================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()  # å³ä½¿å‰é¢æœ‰å¤±è´¥ä¹Ÿè¿è¡Œ
    
    steps:
    - name: Create build summary
      run: |
        echo "# ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… Pipeline Completed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the artifacts above to download the binaries." >> $GITHUB_STEP_SUMMARY
