name: CI/CD Pipeline for PCE-MCP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  GO_VERSION: '1.21'

jobs:
  # ========================================
  # Stage 1: Lint and Code Quality Check
  # ========================================
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout=5m
      continue-on-error: true
    
    - name: Check Go formatting
      run: |
        if [ -n "$(gofmt -s -l .)" ]; then
          echo "âš ï¸ Go code is not formatted properly"
          gofmt -s -d .
        else
          echo "âœ… Go code is properly formatted"
        fi

  # ========================================
  # Stage 2: Test
  # ========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Download dependencies
      run: go mod download
    
    - name: Verify dependencies
      run: go mod verify
    
    - name: Run unit tests
      run: |
        go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
    
    - name: Generate coverage report
      run: |
        go tool cover -func=coverage.txt
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage.txt
        retention-days: 30

  # ========================================
  # Stage 3: Build Multi-Platform Binaries
  # ========================================
  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Build binary for ${{ matrix.os }}-${{ matrix.arch }}
      run: |
        BINARY_NAME=pce-mcp-${{ matrix.os }}-${{ matrix.arch }}
        if [ "${{ matrix.os }}" = "windows" ]; then
          BINARY_NAME="${BINARY_NAME}.exe"
        fi
        
        echo "Building ${BINARY_NAME}..."
        GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -v -o ${BINARY_NAME} ./...
        
        echo "âœ… Build successful: ${BINARY_NAME}"
        ls -lh ${BINARY_NAME}
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v3
      with:
        name: pce-mcp-${{ matrix.os }}-${{ matrix.arch }}
        path: pce-mcp-*
        retention-days: 30

  # ========================================
  # Stage 4: Integration Tests (Optional)
  # ========================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        go test -v -tags=integration -cover ./... || echo "âš ï¸ Integration tests skipped or no tests found"
      continue-on-error: true

  # ========================================
  # Stage 5: Create Release Summary
  # ========================================
  release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Display artifact structure
      run: |
        echo "ðŸ“¦ Build Artifacts:"
        ls -R
    
    - name: Create build summary
      run: |
        echo "# ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ Available Binaries:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Architecture | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | amd64 | âœ… Built |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | arm64 | âœ… Built |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | amd64 | âœ… Built |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | arm64 | âœ… Built |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | amd64 | âœ… Built |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Download artifacts from the Actions tab above**" >> $GITHUB_STEP_SUMMARY
